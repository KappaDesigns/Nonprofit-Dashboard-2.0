<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/site.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/site.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @description implementation of the how the site is edited via
 * the front end editor. Also handles publication of the site
 * commits and changes to the site, and updates the git hub repo
 * of the actaul site so that developers can see the change made
 * by those who are not developers. Built using 
 * {@link https://www.npmjs.com/package/nodegit|NodeGit}
 * 
 * @module lib/Site
 * 
 * 
 * @requires NodeGit
 * @requires module:util/Logger
 */

/**
 * NodeGit
 */
const Git = require('nodegit');
const path = require('path');
const fs = require('fs');

const Logger = require('../util/Logger');

const sitePath = path.resolve(__dirname, '../../site');
const logger = Logger('Site.js', ['error']);

/**
 * @description emulates a git pull to update the site
 * with any recent changes made by the development team
 * @param {User:Object} user takes in a user object.
 * @see module:lib/User
 * @async
 */
async function pullRepo(user) {
	logger.info('Pulling repository...');

	const repo = await openRepository(sitePath);	

	// fetches most recent changes
	logger.info('Fetching...');
	try {
		await repo.fetch('origin');
	} catch (err) {
		logger.error(`Error fetching git.\nError:${err}`);
		return err;
	}

	// creates FETCH_HEAD ref for merge
	logger.info('Creating FETCH_HEAD ref');
	let headRef = await createHeadReference(repo);

	// merges local master with fetched changes
	logger.info('Merging..');
	const date = new Date();
	const signature = Git.Signature.create(
		user.firstName, 
		user.email, 
		date.getTime(), 
		date.getTimezoneOffset()
	);
	const mergePref = Git.Merge.PREFERENCE.NONE;
	try {
		await repo.mergeBranches('master', headRef, signature, mergePref);
	} catch (err) {
		logger.error(`Error merging local git and development git \nError:${err}`);
		throw err;
	}
}

/**
 * @async
 * @description creates a reference to the head where the git was most recently fetched
 * @param {Repository:Object} repo node git repository object.
 */
async function createHeadReference(repo) {
	try {
		let ref = await Git.Reference.lookup(repo, 'FETCH_HEAD');
		return ref;
	} catch(err) {
		logger.error(err);
		throw err;
	}
}

/**
 * @description opens the local repository saved to the machine
 * @param {String} sitePath path to local site git repo
 * @async
 */
async function openRepository(sitePath) {
	return new Promise(async function handlePromise(resolve) {
		logger.info('Opening...');
		let repo;
		try {
			repo = await Git.Repository.open(sitePath);
			return resolve(repo);
		} catch(err) {
			logger.error('Error opening local git repository. This should not happen.'
						+ `Is /site missing? Is /site/.git missing?\nError:${err}`);
			throw err;
		}
	});
}

/**
 * @description Saves the updated file from the web ui to the server git
 * file and adds and commits file to recent changes
 * @param {String} data the html to write and update
 * @param {String} filePath the path at which to update the file
 * @async
 */
async function saveFile(data, filePath) {
	return new Promise(function handlePromise(resolve) {
		fs.writeFile(filePath, data, 'utf-8', async function handleWrite(err) {
			if (err) {
				logger.error(`Error writing to file at ${filePath}\nError: ${err}`);
				throw err;
			}
			logger.info(`Successfully wrote to ${filePath}`);
			
			// open local repo
			let repo = await openRepository(sitePath);
			let index = repo.refreshIndex();
			
			//add to tree
			index.addByPath(filePath);
			index.write();
			index.writeTree();

			await commit();
			resolve();
		});
	});
}

function commit() {

}

function push() {

}

function revert() {

}

module.exports = {
	editPage: saveFile,
	update: pullRepo,
	publish: push,
	revert: revert,
	saveChanges: commit,
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-lib_Site.html">lib/Site</a></li><li><a href="module-util_Logger.html">util/Logger</a></li><li><a href="module-util_MYSQL.html">util/MYSQL</a></li></ul><h3>Classes</h3><ul><li><a href="module-util_Logger.html">util/Logger</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Nov 22 2017 23:26:45 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
